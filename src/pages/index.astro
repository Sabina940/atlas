---
export const prerender = false;

import BaseLayout from "../layouts/BaseLayout.astro";
import { supabase } from "../lib/supabaseClient";

type Post = {
  id: string;
  title: string;
  slug: string;
  excerpt: string | null;
  cover_url: string | null;
  created_at: string;
};

const { data: posts, error } = await supabase
  .from("posts")
  .select("id,title,slug,excerpt,cover_url,created_at")
  .eq("status", "published")
  .order("created_at", { ascending: false })
  .limit(12);

const list = (posts ?? []) as Post[];

const fmt = (iso: string) =>
  new Date(iso).toLocaleDateString("en-GB", { year: "numeric", month: "short", day: "2-digit" });
---

<BaseLayout title="Atlas">
  <main class="atlas">
    <header class="hero">
      <p class="kicker">ATLAS</p>
      <h1>Travel notes, camps, routes & mini-guides</h1>
      <p class="sub">A photographic log — fast to browse, easy to publish.</p>

      <nav class="nav">
        <a class="chip" href="/posts">All entries</a>
        <a class="chip ghost" href="/admin/login">Admin</a>
      </nav>
    </header>

    {error && <p class="error">Couldn’t load posts. Check Supabase connection.</p>}

    <section class="grid" aria-label="Latest entries">
      {list.map((p) => (
        <a class="card" href={`/posts/${p.slug}`}>
          <div class="thumb">
            {p.cover_url ? <img src={p.cover_url} alt="" loading="lazy" /> : <div class="thumbPh" />}
          </div>
          <div class="meta">
            <p class="date">{fmt(p.created_at)}</p>
            <h2>{p.title}</h2>
            {p.excerpt && <p class="excerpt">{p.excerpt}</p>}
          </div>
        </a>
      ))}
    </section>
  </main>
</BaseLayout>