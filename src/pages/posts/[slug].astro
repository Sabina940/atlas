---
export const prerender = false;

import BaseLayout from "../../layouts/BaseLayout.astro";
import { supabase } from "../../lib/supabaseClient";
import { marked } from "marked";
import { CommentsSection } from "../../components/comments/CommentsSection";

const { slug } = Astro.params;

type Post = {
  id: string;
  title: string;
  slug: string;
  content_md: string;
  excerpt: string | null;
  cover_url: string | null;
  created_at: string;
};

if (!slug) return Astro.redirect("/posts");

const { data: post, error } = await supabase
  .from("posts")
  .select("id,title,slug,content_md,excerpt,cover_url,created_at")
  .eq("slug", slug)
  .eq("status", "published")
  .single();

if (error || !post) return Astro.redirect("/posts");

const p = post as Post;

function stripAdminHeader(md: string) {
  const lines = (md ?? "").split("\n");
  const filtered = lines.filter((line) => {
    const t = line.trim();
    if (!t) return true;
    return !/^(Title:|Slug:|Tags:|Cover_url:)\s*/i.test(t);
  });
  return filtered.join("\n").trim();
}

const cleanedMd = stripAdminHeader(p.content_md ?? "");
const html = await marked.parse(cleanedMd);

const fmt = (iso: string) =>
  new Date(iso).toLocaleDateString("en-GB", {
    year: "numeric",
    month: "long",
    day: "2-digit",
  });
---

<BaseLayout title={`Atlas — ${p.title}`}>
  <main class="postPage">
    <header class="postTop">
      <a class="postBack" href="/posts">← All entries</a>
      <p class="postDate">{fmt(p.created_at)}</p>
      <h1 class="postTitle">{p.title}</h1>
      {p.excerpt && <p class="postExcerpt">{p.excerpt}</p>}
    </header>

    {p.cover_url && (
      <figure class="postCover">
        <img src={p.cover_url} alt="" />
      </figure>
    )}

    <article class="postContent prose" set:html={html} />

    <section class="postComments">
      <CommentsSection client:load postId={p.id} />
    </section>
  </main>
</BaseLayout>