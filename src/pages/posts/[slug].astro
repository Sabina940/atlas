---
export const prerender = false;

import BaseLayout from "../../layouts/BaseLayout.astro";
import { supabase } from "../../lib/supabaseClient";

const { slug } = Astro.params;

type Post = {
  id: string;
  title: string;
  slug: string;
  content: string | null;     // HTML string
  excerpt: string | null;
  cover_url: string | null;
  created_at: string;
};

if (!slug) {
  return Astro.redirect("/posts");
}

const { data: post, error } = await supabase
  .from("posts")
  .select("id,title,slug,content,excerpt,cover_url,created_at")
  .eq("slug", slug)
  .eq("status", "published")
  .single();

if (error || !post) {
  return Astro.redirect("/posts");
}

const p = post as Post;

const fmt = (iso: string) =>
  new Date(iso).toLocaleDateString("en-GB", {
    year: "numeric",
    month: "long",
    day: "2-digit",
  });
---

<BaseLayout title={p ? `Atlas — ${p.title}` : "Atlas — Not found"}>
  <main class="page">
    <header class="top">
      <a class="back" href="/posts">← All entries</a>

      {p ? (
        <>
          <p class="date">{fmt(p.created_at)}</p>
          <h1>{p.title}</h1>
          {p.excerpt && <p class="excerpt">{p.excerpt}</p>}
        </>
      ) : (
        <>
          <h1>Not found</h1>
          <p class="excerpt">This entry doesn’t exist (or isn’t published yet).</p>
        </>
      )}
    </header>

    {error && <p class="error">Couldn’t load entry.</p>}

    {p?.cover_url && (
      <figure class="cover">
        <img src={p.cover_url} alt="" />
      </figure>
    )}

    {p?.content && (
      <article class="content" set:html={p.content} />
    )}
  </main>

  <style>
    :global(body){ background:#07080b; color:rgba(255,255,255,.92); }
    .page{ min-height:100svh; padding:28px 18px 70px; max-width:860px; margin:0 auto; }
    .back{ display:inline-block; color:rgba(255,255,255,.75); text-decoration:none; margin-bottom:14px; }
    .date{ margin:0 0 10px; color:rgba(255,255,255,.55); font-size:12px; letter-spacing:.10em; text-transform:uppercase; }
    h1{ margin:0; font-size:clamp(32px,5vw,56px); line-height:1.02; letter-spacing:-.02em; }
    .excerpt{ margin:12px 0 0; color:rgba(255,255,255,.72); line-height:1.65; }
    .error{ margin:18px 0; color:rgba(255,140,140,.95); }

    .cover{
      margin:22px 0 0;
      border-radius:22px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      box-shadow: 0 30px 90px rgba(0,0,0,.45);
    }
    .cover img{ width:100%; height:auto; display:block; }

    /* Content styling (cinematic, readable) */
    .content{
      margin-top:22px;
      line-height:1.85;
      color:rgba(255,255,255,.86);
      font-size: 16px;
    }
    .content :global(p){ margin: 0 0 14px; }
    .content :global(h2){
      margin: 28px 0 10px;
      font-size: 22px;
      letter-spacing: -.01em;
    }
    .content :global(h3){
      margin: 22px 0 10px;
      font-size: 18px;
      letter-spacing: -.01em;
      color: rgba(255,255,255,.90);
    }
    .content :global(a){
      color: rgba(214,199,255,.95);
      text-decoration: none;
      border-bottom: 1px solid rgba(214,199,255,.35);
    }
    .content :global(blockquote){
      margin: 18px 0;
      padding: 12px 14px;
      border-left: 2px solid rgba(214,199,255,.55);
      background: rgba(255,255,255,.04);
      border-radius: 12px;
      color: rgba(255,255,255,.80);
    }
    .content :global(img){
      max-width: 100%;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      margin: 12px 0;
    }
    .content :global(hr){
      border: 0;
      height: 1px;
      background: rgba(255,255,255,.10);
      margin: 26px 0;
    }
  </style>
</BaseLayout>