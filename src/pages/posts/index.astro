---
export const prerender = false;

import BaseLayout from "../../layouts/BaseLayout.astro";
import { supabase } from "../../lib/supabaseClient";

type Post = {
  id: string;
  title: string;
  slug: string;
  excerpt: string | null;
  cover_url: string | null;
  created_at: string;
};

const { data: posts, error } = await supabase
  .from("posts")
  .select("id,title,slug,excerpt,cover_url,created_at")
  .eq("status", "published")
  .order("created_at", { ascending: false });

const list = (posts ?? []) as Post[];

const fmt = (iso: string) =>
  new Date(iso).toLocaleDateString("en-GB", { year: "numeric", month: "short", day: "2-digit" });
---

<BaseLayout title="Atlas — Entries">
  <main class="atlasEntries">
    <header class="head">
      <a class="back" href="/">← Back</a>
      <h1>All entries</h1>
      <p class="sub">Browse everything published so far.</p>
    </header>

    {error && <p class="error">Couldn’t load posts.</p>}

    <section class="list">
      {list.map((p) => (
        <a class="row" href={`/posts/${p.slug}`}>
          <div class="thumb">
            {p.cover_url ? <img src={p.cover_url} alt="" loading="lazy" /> : <div class="thumbPh" />}
          </div>
          <div class="txt">
            <p class="date">{fmt(p.created_at)}</p>
            <h2>{p.title}</h2>
            {p.excerpt && <p class="excerpt">{p.excerpt}</p>}
          </div>
        </a>
      ))}
    </section>
  </main>
</BaseLayout>